<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ephemeral Environments Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #f4f4f4;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        h1 {
            color: #0066cc;
        }
        .environments-container {
            margin-top: 20px;
        }
        .environment-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .environment-card h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-running {
            background-color: #d4edda;
            color: #155724;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        .status-failed {
            background-color: #f8d7da;
            color: #721c24;
        }
        .button {
            display: inline-block;
            padding: 8px 16px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button-danger {
            background-color: #dc3545;
        }
        .button-danger:hover {
            background-color: #c82333;
        }
        #loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ephemeral Environments Dashboard</h1>
            <p>Manage your ephemeral environments for pull requests</p>
        </header>

        <div>
            <button id="refreshButton" class="button">Refresh Environments</button>
        </div>

        <div id="loading">Loading environments...</div>

        <div id="environments" class="environments-container">
            <!-- Environment cards will be dynamically added here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fetch environments when the page loads
            fetchEnvironments();

            // Set up refresh button
            document.getElementById('refreshButton').addEventListener('click', fetchEnvironments);
        });

        function fetchEnvironments() {
            const loadingElement = document.getElementById('loading');
            const environmentsContainer = document.getElementById('environments');

            // Show loading indicator
            loadingElement.style.display = 'block';
            environmentsContainer.innerHTML = '';

            // Fetch environments from API
            fetch('/api/environments')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Hide loading indicator
                    loadingElement.style.display = 'none';

                    // Display environments
                    if (data.environments && data.environments.length > 0) {
                        data.environments.forEach(env => {
                            environmentsContainer.appendChild(createEnvironmentCard(env));
                        });
                    } else {
                        environmentsContainer.innerHTML = '<p>No environments found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching environments:', error);
                    loadingElement.style.display = 'none';
                    environmentsContainer.innerHTML = '<p>Error loading environments. Please try again later.</p>';
                });
        }

        function createEnvironmentCard(environment) {
            const card = document.createElement('div');
            card.className = 'environment-card';

            // Determine status class
            let statusClass = 'status-pending';
            if (environment.status === 'running') {
                statusClass = 'status-running';
            } else if (environment.status === 'failed') {
                statusClass = 'status-failed';
            }

            card.innerHTML = `
                <h3>${environment.id}</h3>
                <p><strong>Repository:</strong> ${environment.repositoryName}</p>
                <p><strong>PR Number:</strong> ${environment.prNumber}</p>
                <p><strong>Status:</strong> <span class="status ${statusClass}">${environment.status}</span></p>
                <p><strong>Created:</strong> ${new Date(environment.createdAt).toLocaleString()}</p>
                <div>
                    <button class="button view-logs-btn" data-id="${environment.id}">View Logs</button>
                    <button class="button button-danger delete-btn" data-id="${environment.id}">Delete</button>
                </div>
            `;

            // Add event listeners
            setTimeout(() => {
                const viewLogsBtn = card.querySelector('.view-logs-btn');
                const deleteBtn = card.querySelector('.delete-btn');

                viewLogsBtn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    viewEnvironmentLogs(id);
                });

                deleteBtn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteEnvironment(id);
                });
            }, 0);

            return card;
        }

        function viewEnvironmentLogs(id) {
            // Fetch and display logs
            fetch(`/api/environments/${id}/logs`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(`Logs for ${id}:\n\n${data.logs.join('\n')}`);
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    alert('Error loading logs. Please try again later.');
                });
        }

        function deleteEnvironment(id) {
            if (confirm(`Are you sure you want to delete environment ${id}?`)) {
                fetch(`/api/environments/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    alert(`Environment ${id} deleted successfully.`);
                    fetchEnvironments(); // Refresh the list
                })
                .catch(error => {
                    console.error('Error deleting environment:', error);
                    alert('Error deleting environment. Please try again later.');
                });
            }
        }
    </script>
</body>
</html>
